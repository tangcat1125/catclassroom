  // --- START OF <script type="module"> in handwrite-upload.html (ç¨ç«‹é‹ä½œä¿®æ”¹ç‰ˆ) ---
  <script type="module">
    // 1. å¼•å…¥ Firebase å·¥å…·
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // 2. Firebase è¨­å®š (èˆ‡å­¸ç”Ÿç«¯ä¸€è‡´)
    const firebaseConfig = {
      apiKey: "AIzaSyBB3wmBveYumzmPUQuIr4ApZYxKnnT-IdA",
      authDomain: "catclassroom-login.firebaseapp.com",
      databaseURL: "https://catclassroom-login-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "catclassroom-login",
      storageBucket: "catclassroom-login.appspot.com", // ä½¿ç”¨ .appspot.com
      messagingSenderId: "123487233181",
      appId: "1:123487233181:web:aecc2891dc2d1096962074" // ç¢ºèªæ˜¯å­¸ç”Ÿç«¯/æ‰‹å¯«æ¨¡çµ„çš„ App ID
    };

    // 3. åˆå§‹åŒ– Firebase
    let db; // æŠŠ db å®£å‘Šæå‡ºä¾†
    try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        console.log("Handwrite Firebase åˆå§‹åŒ–æˆåŠŸï¼");
    } catch(e) {
        console.error("Handwrite Firebase åˆå§‹åŒ–å¤±æ•—ï¼", e);
        alert("éŒ¯èª¤ï¼šç„¡æ³•é€£æ¥å¾Œç«¯æœå‹™ï¼æ‰‹å¯«åŠŸèƒ½å¯èƒ½ç„¡æ³•ä¸Šå‚³ã€‚");
        // å¯ä»¥åœ¨æ­¤ç¦ç”¨ä¸Šå‚³æŒ‰éˆ•ç­‰
        const uploadButton = document.querySelector('button[onclick="uploadHandwrite()"]');
        if(uploadButton) {
            uploadButton.disabled = true;
            uploadButton.textContent = 'é€£ç·šå¤±æ•—';
            uploadButton.style.backgroundColor = 'grey';
        }
    }


    // 4. å–å¾—ç•«é¢å…ƒç´ å’Œè¨­å®š Canvas
    const canvas = document.getElementById('handwriteCanvas');
    const ctx = canvas.getContext('2d');
    const uploadStatusDiv = document.getElementById('uploadStatus');
    const previewImage = document.getElementById('previewImage');
    const pageTitle = document.querySelector('h1'); // å–å¾—æ¨™é¡Œå…ƒç´ 
    let drawing = false;
    let hasContent = false; // è¿½è¹¤ç•«å¸ƒæ˜¯å¦æœ‰å…§å®¹

    // 5. è®€å– URL åƒæ•¸ (è™•ç†è€å¸«ç™¼ä¾†çš„ä»»å‹™)
    const urlParams = new URLSearchParams(window.location.search);
    const backgroundUrl = urlParams.get('backgroundUrl'); // è€å¸«æˆªåœ–çš„ URL
    let questionId = urlParams.get('questionId'); // å¯èƒ½æ˜¯é¡Œç›® ID æˆ– æˆªåœ–ä»»å‹™ ID
    const studentIdFromUrl = urlParams.get('studentId'); // å­¸ç”Ÿ ID (å¦‚æœæœ‰çš„è©±)

    // ç²å–å­¸ç”Ÿè³‡è¨Š (å„ªå…ˆå¾ URL è®€å–ï¼Œå…¶æ¬¡å¾ sessionStorage)
    const studentId = studentIdFromUrl || sessionStorage.getItem("studentId") || "guest";
    const studentName = sessionStorage.getItem("studentName") || "åŒ¿åå­¸ç”Ÿ";
    // const studentClass = sessionStorage.getItem("studentClass") || "æœªçŸ¥ç­ç´š"; // é€™å€‹é é¢å¯èƒ½ä¸éœ€è¦ç­ç´š

    console.log(`æ‰‹å¯«é é¢è¼‰å…¥: studentId=${studentId}, questionId=${questionId}, backgroundUrl=${backgroundUrl ? 'æœ‰' : 'ç„¡'}`);

    // 6. åˆå§‹åŒ–ç•«å¸ƒ (ç¹ªè£½èƒŒæ™¯æˆ–æ¸…ç©º)
    function initializeCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height); // å…ˆæ¸…ç©º
        hasContent = false; // é‡è¨­å…§å®¹æ¨™è¨˜
        if (backgroundUrl) {
            console.log("å˜—è©¦è¼‰å…¥èƒŒæ™¯åœ–:", backgroundUrl);
            pageTitle.innerText = 'ğŸ“ æ™ºæ…§è¨»è¨˜æ¨¡å¼'; // ä¿®æ”¹æ¨™é¡Œ
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                console.log("èƒŒæ™¯åœ–è¼‰å…¥æˆåŠŸï¼Œç¹ªè£½...");
                try {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    console.log("èƒŒæ™¯åœ–ç¹ªè£½å®Œæˆã€‚");
                    // èƒŒæ™¯åœ–ä¸ç®—å­¸ç”Ÿç•«çš„å…§å®¹ï¼Œæ‰€ä»¥ hasContent ä»ç„¶æ˜¯ false
                } catch (drawError) {
                     console.error("ç¹ªè£½èƒŒæ™¯åœ–å¤±æ•—:", drawError);
                     alert("éŒ¯èª¤ï¼šç„¡æ³•ç¹ªè£½èƒŒæ™¯åœ–ã€‚");
                     // ç¹ªè£½å¤±æ•—ï¼Œé‚„æ˜¯å¡«å€‹ç™½è‰²èƒŒæ™¯
                     ctx.fillStyle = "#FFFFFF";
                     ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            };
            img.onerror = function(e) {
                console.error("è¼‰å…¥èƒŒæ™¯åœ–å¤±æ•—:", backgroundUrl, e);
                alert("éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥è€å¸«æä¾›çš„èƒŒæ™¯åœ–ï¼Œè«‹æª¢æŸ¥åœ–ç‰‡é€£çµæˆ–ç¶²è·¯ã€‚");
                pageTitle.innerText = 'âš ï¸ èƒŒæ™¯è¼‰å…¥å¤±æ•— (è‡ªç”±ç¹ªåœ–)';
                // è¼‰å…¥å¤±æ•—ï¼Œå¡«ç™½è‰²èƒŒæ™¯
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            };
            // ä½¿ç”¨ decodeURIComponent è§£ç¢¼ URL
            try {
                 img.src = decodeURIComponent(backgroundUrl);
            } catch (uriError) {
                 console.error("èƒŒæ™¯åœ– URL è§£ç¢¼å¤±æ•—:", uriError);
                 alert("éŒ¯èª¤ï¼šèƒŒæ™¯åœ–é€£çµæ ¼å¼éŒ¯èª¤ã€‚");
                 ctx.fillStyle = "#FFFFFF";
                 ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

        } else {
            console.log("ç„¡èƒŒæ™¯åœ–ï¼Œåˆå§‹åŒ–ç‚ºç©ºç™½ç•«å¸ƒ (è‡ªç”±ç¹ªåœ–æ¨¡å¼)ã€‚");
            pageTitle.innerText = 'ğŸ¨ è‡ªç”±ç¹ªåœ–æ¨¡å¼'; // ä¿®æ”¹æ¨™é¡Œ
            // å¡«ä¸Šç™½è‰²èƒŒæ™¯
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        previewImage.style.display = "none"; // éš±è—èˆŠé è¦½
        uploadStatusDiv.textContent = ""; // æ¸…é™¤èˆŠç‹€æ…‹
    }

    // 7. Canvas ç¹ªåœ–äº‹ä»¶è™•ç†å‡½æ•¸
    function getCanvasPos(e) {
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches ? e.touches[0] : null;
      return {
        x: touch ? touch.clientX - rect.left : e.offsetX,
        y: touch ? touch.clientY - rect.top : e.offsetY
      };
    }

    function startDraw(e) {
      // åªæœ‰ç•¶ Firebase åˆå§‹åŒ–æˆåŠŸæ‰å…è¨±ç¹ªåœ– (å¯é¸)
       // if (!db) return;
      e.preventDefault(); // é˜»æ­¢é é¢æ»¾å‹•ç­‰é è¨­è¡Œç‚º
      drawing = true;
      hasContent = true; // é–‹å§‹ç•«åœ–å°±ç®—æœ‰å…§å®¹
      const pos = getCanvasPos(e);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    }

    function draw(e) {
      if (!drawing) return;
      e.preventDefault();
      const pos = getCanvasPos(e);
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000000'; // é»‘è‰²
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      // åœ¨ç•«å®Œä¸€ç­†å¾Œé‡æ–°é–‹å§‹è·¯å¾‘ï¼Œé¿å…å½±éŸ¿ä¸‹ä¸€ç­†çš„ moveTo
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    }

    function endDraw(e) {
      if (!drawing) return;
      e.preventDefault();
      drawing = false;
      ctx.beginPath(); // çµæŸç›®å‰è·¯å¾‘ï¼Œé¿å… MouseOut å¾Œåˆé€£ç·š
    }

    // 8. ç¶å®šäº‹ä»¶ç›£è½å™¨
    // é›»è…¦æ»‘é¼ äº‹ä»¶
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseout', endDraw); // æ»‘é¼ ç§»å‡ºç•«å¸ƒä¹Ÿåœæ­¢ç¹ªç•«
    // è§¸æ§è¢å¹•äº‹ä»¶
    canvas.addEventListener('touchstart', startDraw, { passive: false }); // passive:false å…è¨± preventDefault
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', endDraw);
    canvas.addEventListener('touchcancel', endDraw); // ä¾‹å¦‚è¢«ç³»çµ±ä¸­æ–·è§¸æ§

    // 9. æŒ‰éˆ•åŠŸèƒ½å‡½æ•¸ (æ›è¼‰åˆ° window)

    /**
     * æ¸…é™¤ç•«å¸ƒå…§å®¹ (ä¿ç•™èƒŒæ™¯åœ–)
     */
    window.clearCanvas = function () {
      if (!confirm("ç¢ºå®šè¦æ¸…é™¤ä½ ç•«çš„æ‰€æœ‰å…§å®¹å—ï¼ŸèƒŒæ™¯åœ–å°‡æœƒä¿ç•™ã€‚")) {
          return;
      }
      console.log("æ¸…é™¤ç•«å¸ƒå…§å®¹...");
      // åªæ¸…é™¤ä½¿ç”¨è€…ç•«çš„å…§å®¹ï¼Œéœ€è¦é‡æ–°ç¹ªè£½èƒŒæ™¯
      initializeCanvas(); // é‡æ–°åˆå§‹åŒ–ç•«å¸ƒå³å¯
    }

    /**
     * ä¸Šå‚³æ‰‹å¯«ä½œç­”åˆ° Firebase
     */
    window.uploadHandwrite = async function () {
      // æª¢æŸ¥ Firebase æ˜¯å¦å¯ç”¨
       if (!db) {
           alert("éŒ¯èª¤ï¼šç„¡æ³•é€£æ¥å¾Œç«¯æœå‹™ï¼Œç„¡æ³•ä¸Šå‚³ã€‚");
           return;
       }
       // æª¢æŸ¥ç•«å¸ƒæ˜¯å¦æœ‰å…§å®¹ (ä¸å«èƒŒæ™¯åœ–)
       if (!hasContent) {
           alert("è«‹å…ˆåœ¨ç•«å¸ƒä¸Šç•«é»æ±è¥¿å†ä¸Šå‚³ï¼");
           return;
       }


      // æ±ºå®š questionIdï¼šå¦‚æœ URL æ²’æœ‰æä¾›ï¼Œå°±ä½¿ç”¨é è¨­å€¼
      const finalQuestionId = questionId || `è‡ªç”±ç¹ªåœ–_${Date.now()}`;
      console.log(`æº–å‚™ä¸Šå‚³æ‰‹å¯«: studentId=${studentId}, questionId=${finalQuestionId}`);

      // å°‡ Canvas å…§å®¹è½‰æ›ç‚º PNG æ ¼å¼çš„ Data URL
      let imageUrl;
      try {
           imageUrl = canvas.toDataURL("image/png");
           // æª¢æŸ¥ Data URL æ˜¯å¦éé•· (æŸäº›ç€è¦½å™¨æˆ–ç’°å¢ƒå¯èƒ½æœ‰é™åˆ¶)
           if (imageUrl.length > 2 * 1024 * 1024) { // é™åˆ¶ 2MB (Data URL é€šå¸¸æ¯”åŸåœ–å¤§)
               console.warn("ç”¢ç”Ÿçš„åœ–ç‰‡ Data URL éé•·ï¼Œå¯èƒ½ç„¡æ³•å„²å­˜ã€‚");
               alert("è­¦å‘Šï¼šç¹ªåœ–å…§å®¹éæ–¼è¤‡é›œï¼Œå¯èƒ½ç„¡æ³•æˆåŠŸå„²å­˜ã€‚è«‹å˜—è©¦ç°¡åŒ–å…§å®¹ã€‚");
               // å¯ä»¥é¸æ“‡æ˜¯å¦ç¹¼çºŒå˜—è©¦ä¸Šå‚³
           }
      } catch (e) {
          console.error("Canvas è½‰æ›ç‚º Data URL å¤±æ•—:", e);
          alert("éŒ¯èª¤ï¼šç„¡æ³•å°‡ç¹ªåœ–è½‰æ›ç‚ºåœ–ç‰‡æ ¼å¼ã€‚");
          return;
      }


      // æº–å‚™è¦å„²å­˜çš„è³‡æ–™
      const data = {
        studentId: studentId,
        studentName: studentName,
        // studentClass: studentClass, // å¯é¸
        questionId: finalQuestionId, // ä½¿ç”¨æœ€çµ‚ç¢ºå®šçš„ ID
        imageUrl: imageUrl,          // åŒ…å«èƒŒæ™¯å’Œç­†è·¡çš„åœ–ç‰‡è³‡æ–™
        hasBackground: !!backgroundUrl, // æ¨™è¨˜æ˜¯å¦æœ‰èƒŒæ™¯åœ–
        timestamp: Date.now()
      };

      // æŒ‡å®š Firebase å„²å­˜è·¯å¾‘ (ä¾‹å¦‚ handwriting/S01/è‡ªç”±ç¹ªåœ–_12345)
      const refPath = ref(db, `handwriting/${studentId}/${finalQuestionId}`);

      // æ›´æ–°ç•«é¢ç‹€æ…‹ç‚ºä¸Šå‚³ä¸­
      if (uploadStatusDiv) {
          uploadStatusDiv.style.color = "#555";
          uploadStatusDiv.textContent = "ğŸ“¤ ä¸Šå‚³ä¸­ï¼Œè«‹ç¨å€™...";
      }
      if (previewImage) previewImage.style.display = "none"; // éš±è—èˆŠé è¦½

      // åŸ·è¡Œä¸Šå‚³ (ä½¿ç”¨ set æœƒè¦†è“‹åŒåèˆŠä½œç­”)
      try {
        await set(refPath, data);
        console.log("æ‰‹å¯«è³‡æ–™æˆåŠŸä¸Šå‚³ï¼");
        if (uploadStatusDiv) {
            uploadStatusDiv.style.color = "green";
            uploadStatusDiv.textContent = "âœ… ä¸Šå‚³æˆåŠŸï¼";
        }
        // é¡¯ç¤ºå‰›ä¸Šå‚³çš„åœ–ç‰‡é è¦½
        if (previewImage) {
            previewImage.src = imageUrl;
            previewImage.style.display = "block";
        }
        // ä¸Šå‚³æˆåŠŸå¾Œï¼Œå¯ä»¥è€ƒæ…®è‡ªå‹•é—œé–‰è¦–çª—æˆ–æç¤ºä½¿ç”¨è€…
        // alert("ä½œç­”å·²ä¸Šå‚³æˆåŠŸï¼å¯ä»¥é—œé–‰æ­¤åˆ†é äº†ã€‚");
        // window.close(); // å¯èƒ½è¢«ç€è¦½å™¨é˜»æ“‹

      } catch (e) {
        console.error("âŒ ä¸Šå‚³æ‰‹å¯«è³‡æ–™åˆ° Firebase å¤±æ•—ï¼š", e);
        if (uploadStatusDiv) {
            uploadStatusDiv.style.color = "red";
            uploadStatusDiv.textContent = "âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦";
        }
        alert("âŒ ä¸Šå‚³å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«è€å¸«ã€‚");
      }
    }

    // 10. é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–ç•«å¸ƒ
    initializeCanvas();

  </script>
  // --- END OF <script type="module"> in handwrite-upload.html ---
