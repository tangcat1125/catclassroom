  // --- START OF <script type="module"> in handwrite-upload.html (獨立運作修改版) ---
  <script type="module">
    // 1. 引入 Firebase 工具
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // 2. Firebase 設定 (與學生端一致)
    const firebaseConfig = {
      apiKey: "AIzaSyBB3wmBveYumzmPUQuIr4ApZYxKnnT-IdA",
      authDomain: "catclassroom-login.firebaseapp.com",
      databaseURL: "https://catclassroom-login-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "catclassroom-login",
      storageBucket: "catclassroom-login.appspot.com", // 使用 .appspot.com
      messagingSenderId: "123487233181",
      appId: "1:123487233181:web:aecc2891dc2d1096962074" // 確認是學生端/手寫模組的 App ID
    };

    // 3. 初始化 Firebase
    let db; // 把 db 宣告提出來
    try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        console.log("Handwrite Firebase 初始化成功！");
    } catch(e) {
        console.error("Handwrite Firebase 初始化失敗！", e);
        alert("錯誤：無法連接後端服務！手寫功能可能無法上傳。");
        // 可以在此禁用上傳按鈕等
        const uploadButton = document.querySelector('button[onclick="uploadHandwrite()"]');
        if(uploadButton) {
            uploadButton.disabled = true;
            uploadButton.textContent = '連線失敗';
            uploadButton.style.backgroundColor = 'grey';
        }
    }


    // 4. 取得畫面元素和設定 Canvas
    const canvas = document.getElementById('handwriteCanvas');
    const ctx = canvas.getContext('2d');
    const uploadStatusDiv = document.getElementById('uploadStatus');
    const previewImage = document.getElementById('previewImage');
    const pageTitle = document.querySelector('h1'); // 取得標題元素
    let drawing = false;
    let hasContent = false; // 追蹤畫布是否有內容

    // 5. 讀取 URL 參數 (處理老師發來的任務)
    const urlParams = new URLSearchParams(window.location.search);
    const backgroundUrl = urlParams.get('backgroundUrl'); // 老師截圖的 URL
    let questionId = urlParams.get('questionId'); // 可能是題目 ID 或 截圖任務 ID
    const studentIdFromUrl = urlParams.get('studentId'); // 學生 ID (如果有的話)

    // 獲取學生資訊 (優先從 URL 讀取，其次從 sessionStorage)
    const studentId = studentIdFromUrl || sessionStorage.getItem("studentId") || "guest";
    const studentName = sessionStorage.getItem("studentName") || "匿名學生";
    // const studentClass = sessionStorage.getItem("studentClass") || "未知班級"; // 這個頁面可能不需要班級

    console.log(`手寫頁面載入: studentId=${studentId}, questionId=${questionId}, backgroundUrl=${backgroundUrl ? '有' : '無'}`);

    // 6. 初始化畫布 (繪製背景或清空)
    function initializeCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height); // 先清空
        hasContent = false; // 重設內容標記
        if (backgroundUrl) {
            console.log("嘗試載入背景圖:", backgroundUrl);
            pageTitle.innerText = '📝 智慧註記模式'; // 修改標題
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                console.log("背景圖載入成功，繪製...");
                try {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    console.log("背景圖繪製完成。");
                    // 背景圖不算學生畫的內容，所以 hasContent 仍然是 false
                } catch (drawError) {
                     console.error("繪製背景圖失敗:", drawError);
                     alert("錯誤：無法繪製背景圖。");
                     // 繪製失敗，還是填個白色背景
                     ctx.fillStyle = "#FFFFFF";
                     ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            };
            img.onerror = function(e) {
                console.error("載入背景圖失敗:", backgroundUrl, e);
                alert("錯誤：無法載入老師提供的背景圖，請檢查圖片連結或網路。");
                pageTitle.innerText = '⚠️ 背景載入失敗 (自由繪圖)';
                // 載入失敗，填白色背景
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            };
            // 使用 decodeURIComponent 解碼 URL
            try {
                 img.src = decodeURIComponent(backgroundUrl);
            } catch (uriError) {
                 console.error("背景圖 URL 解碼失敗:", uriError);
                 alert("錯誤：背景圖連結格式錯誤。");
                 ctx.fillStyle = "#FFFFFF";
                 ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

        } else {
            console.log("無背景圖，初始化為空白畫布 (自由繪圖模式)。");
            pageTitle.innerText = '🎨 自由繪圖模式'; // 修改標題
            // 填上白色背景
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        previewImage.style.display = "none"; // 隱藏舊預覽
        uploadStatusDiv.textContent = ""; // 清除舊狀態
    }

    // 7. Canvas 繪圖事件處理函數
    function getCanvasPos(e) {
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches ? e.touches[0] : null;
      return {
        x: touch ? touch.clientX - rect.left : e.offsetX,
        y: touch ? touch.clientY - rect.top : e.offsetY
      };
    }

    function startDraw(e) {
      // 只有當 Firebase 初始化成功才允許繪圖 (可選)
       // if (!db) return;
      e.preventDefault(); // 阻止頁面滾動等預設行為
      drawing = true;
      hasContent = true; // 開始畫圖就算有內容
      const pos = getCanvasPos(e);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    }

    function draw(e) {
      if (!drawing) return;
      e.preventDefault();
      const pos = getCanvasPos(e);
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000000'; // 黑色
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      // 在畫完一筆後重新開始路徑，避免影響下一筆的 moveTo
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    }

    function endDraw(e) {
      if (!drawing) return;
      e.preventDefault();
      drawing = false;
      ctx.beginPath(); // 結束目前路徑，避免 MouseOut 後又連線
    }

    // 8. 綁定事件監聽器
    // 電腦滑鼠事件
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseout', endDraw); // 滑鼠移出畫布也停止繪畫
    // 觸控螢幕事件
    canvas.addEventListener('touchstart', startDraw, { passive: false }); // passive:false 允許 preventDefault
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', endDraw);
    canvas.addEventListener('touchcancel', endDraw); // 例如被系統中斷觸控

    // 9. 按鈕功能函數 (掛載到 window)

    /**
     * 清除畫布內容 (保留背景圖)
     */
    window.clearCanvas = function () {
      if (!confirm("確定要清除你畫的所有內容嗎？背景圖將會保留。")) {
          return;
      }
      console.log("清除畫布內容...");
      // 只清除使用者畫的內容，需要重新繪製背景
      initializeCanvas(); // 重新初始化畫布即可
    }

    /**
     * 上傳手寫作答到 Firebase
     */
    window.uploadHandwrite = async function () {
      // 檢查 Firebase 是否可用
       if (!db) {
           alert("錯誤：無法連接後端服務，無法上傳。");
           return;
       }
       // 檢查畫布是否有內容 (不含背景圖)
       if (!hasContent) {
           alert("請先在畫布上畫點東西再上傳！");
           return;
       }


      // 決定 questionId：如果 URL 沒有提供，就使用預設值
      const finalQuestionId = questionId || `自由繪圖_${Date.now()}`;
      console.log(`準備上傳手寫: studentId=${studentId}, questionId=${finalQuestionId}`);

      // 將 Canvas 內容轉換為 PNG 格式的 Data URL
      let imageUrl;
      try {
           imageUrl = canvas.toDataURL("image/png");
           // 檢查 Data URL 是否過長 (某些瀏覽器或環境可能有限制)
           if (imageUrl.length > 2 * 1024 * 1024) { // 限制 2MB (Data URL 通常比原圖大)
               console.warn("產生的圖片 Data URL 過長，可能無法儲存。");
               alert("警告：繪圖內容過於複雜，可能無法成功儲存。請嘗試簡化內容。");
               // 可以選擇是否繼續嘗試上傳
           }
      } catch (e) {
          console.error("Canvas 轉換為 Data URL 失敗:", e);
          alert("錯誤：無法將繪圖轉換為圖片格式。");
          return;
      }


      // 準備要儲存的資料
      const data = {
        studentId: studentId,
        studentName: studentName,
        // studentClass: studentClass, // 可選
        questionId: finalQuestionId, // 使用最終確定的 ID
        imageUrl: imageUrl,          // 包含背景和筆跡的圖片資料
        hasBackground: !!backgroundUrl, // 標記是否有背景圖
        timestamp: Date.now()
      };

      // 指定 Firebase 儲存路徑 (例如 handwriting/S01/自由繪圖_12345)
      const refPath = ref(db, `handwriting/${studentId}/${finalQuestionId}`);

      // 更新畫面狀態為上傳中
      if (uploadStatusDiv) {
          uploadStatusDiv.style.color = "#555";
          uploadStatusDiv.textContent = "📤 上傳中，請稍候...";
      }
      if (previewImage) previewImage.style.display = "none"; // 隱藏舊預覽

      // 執行上傳 (使用 set 會覆蓋同名舊作答)
      try {
        await set(refPath, data);
        console.log("手寫資料成功上傳！");
        if (uploadStatusDiv) {
            uploadStatusDiv.style.color = "green";
            uploadStatusDiv.textContent = "✅ 上傳成功！";
        }
        // 顯示剛上傳的圖片預覽
        if (previewImage) {
            previewImage.src = imageUrl;
            previewImage.style.display = "block";
        }
        // 上傳成功後，可以考慮自動關閉視窗或提示使用者
        // alert("作答已上傳成功！可以關閉此分頁了。");
        // window.close(); // 可能被瀏覽器阻擋

      } catch (e) {
        console.error("❌ 上傳手寫資料到 Firebase 失敗：", e);
        if (uploadStatusDiv) {
            uploadStatusDiv.style.color = "red";
            uploadStatusDiv.textContent = "❌ 上傳失敗，請檢查網路或稍後再試";
        }
        alert("❌ 上傳失敗！請檢查網路連線或聯繫老師。");
      }
    }

    // 10. 頁面載入時初始化畫布
    initializeCanvas();

  </script>
  // --- END OF <script type="module"> in handwrite-upload.html ---
