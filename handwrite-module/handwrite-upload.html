<!-- START OF FILE handwrite-upload.html (v2 - æ”¯æ´èƒŒæ™¯åœ–èˆ‡ç¨ç«‹é‹ä½œ) -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" /> <!-- å„ªåŒ–ç§»å‹•ç«¯ -->
  <title>æ™ºæ…§æ‰‹å¯«</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      text-align: center;
      background-color: #f0f4f8; /* æ·¡è—ç°è‰²èƒŒæ™¯ */
      padding: 15px;
      margin: 0;
      display: flex; /* ä½¿ç”¨ Flexbox ä½ˆå±€ */
      flex-direction: column; /* å‚ç›´æ’åˆ— */
      align-items: center; /* æ°´å¹³å±…ä¸­ */
      min-height: 95vh; /* è‡³å°‘ä½”æ»¿è¦–çª—é«˜åº¦ */
    }
    h1 {
      color: #1a237e; /* æ·±è—è‰²æ¨™é¡Œ */
      margin-bottom: 15px;
      font-size: 1.5em;
    }
    canvas {
      border: 2px solid #90a4ae; /* è—ç°è‰²é‚Šæ¡† */
      margin-top: 10px;
      background: #ffffff; /* ç™½è‰²ç•«å¸ƒèƒŒæ™¯ */
      touch-action: none; /* é˜²æ­¢è§¸æ§æ™‚ç€è¦½å™¨é è¨­è¡Œç‚º (å¦‚ç¸®æ”¾) */
      cursor: crosshair; /* ç•«å¸ƒä¸Šé¡¯ç¤ºåå­—æ¸¸æ¨™ */
      max-width: 100%; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* ç´°å¾®é™°å½± */
      border-radius: 4px; /* è¼•å¾®åœ“è§’ */
    }
    .controls { /* æŒ‰éˆ•å®¹å™¨ */
        margin-top: 15px;
        margin-bottom: 15px;
        display: flex; /* è®“æŒ‰éˆ•ä¸¦æ’ */
        gap: 10px; /* æŒ‰éˆ•é–“è· */
        flex-wrap: wrap; /* æŒ‰éˆ•å¤šæ™‚æ›è¡Œ */
        justify-content: center; /* æŒ‰éˆ•å±…ä¸­ */
    }
    button {
      padding: 10px 18px;
      font-size: 1em;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #4caf50; /* ç¶ è‰² */
      color: white;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #388e3c; /* æ·±ç¶ è‰² */
    }
    button[onclick="clearCanvas()"] {
        background-color: #ff9800; /* æ©˜è‰² */
    }
     button[onclick="clearCanvas()"]:hover {
        background-color: #f57c00; /* æ·±æ©˜è‰² */
    }
     button:disabled { /* ç¦ç”¨æŒ‰éˆ•æ¨£å¼ */
        background-color: #bdbdbd;
        cursor: not-allowed;
     }
    #uploadStatus {
      margin-top: 10px;
      font-size: 1em;
      font-weight: bold;
      min-height: 1.2em; /* ä½”ä½é¿å…è·³å‹• */
    }
    #previewImage {
      margin-top: 10px;
      max-width: 90%; /* é™åˆ¶é è¦½åœ–å¤§å° */
      max-height: 100px;
      border: 1px solid #ccc;
      display: none; /* é è¨­éš±è— */
      background-color: #eee; /* é è¦½åœ–èƒŒæ™¯ */
    }
    /* é‡å°å°è¢å¹•èª¿æ•´ç•«å¸ƒå¤§å°å’ŒæŒ‰éˆ• */
    @media (max-width: 400px) {
        canvas {
             /* åœ¨JSä¸­è¨­ç½®äº†å¤§å°ï¼Œé€™è£¡å¯ä»¥ä¸ç”¨å‹• */
        }
        button {
            font-size: 0.9em;
            padding: 8px 15px;
        }
        h1 {
             font-size: 1.3em;
        }
    }
  </style>
</head>
<body>
  <!-- æ¨™é¡Œæœƒç”± JS å‹•æ…‹ä¿®æ”¹ -->
  <h1 id="pageTitle">ğŸ¨ è¼‰å…¥ä¸­...</h1>

  <!-- ç¹ªåœ–ç•«å¸ƒ -->
  <canvas id="handwriteCanvas" width="320" height="320"></canvas> <!-- çµ¦å®šåˆå§‹å¤§å° -->

  <!-- æ§åˆ¶æŒ‰éˆ• -->
  <div class="controls">
    <button onclick="clearCanvas()">âœï¸ æ¸…é™¤ç­†è·¡</button>
    <button onclick="uploadHandwrite()">ğŸ“¤ ä¸Šå‚³ä½œç­”</button>
  </div>

  <!-- ä¸Šå‚³ç‹€æ…‹å’Œé è¦½ -->
  <div id="uploadStatus"></div>
  <img id="previewImage" alt="ä¸Šå‚³é è¦½"/>

  <!-- JavaScript ç¨‹å¼ç¢¼ -->
  <script type="module">
    // 1. å¼•å…¥ Firebase å·¥å…·
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // 2. Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyBB3wmBveYumzmPUQuIr4ApZYxKnnT-IdA",
      authDomain: "catclassroom-login.firebaseapp.com",
      databaseURL: "https://catclassroom-login-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "catclassroom-login",
      storageBucket: "catclassroom-login.appspot.com",
      messagingSenderId: "123487233181",
      appId: "1:123487233181:web:aecc2891dc2d1096962074" // ç¢ºèª App ID
    };

    // 3. åˆå§‹åŒ– Firebase
    let db = null; // åˆå§‹åŒ–ç‚º null
    const uploadButton = document.querySelector('button[onclick="uploadHandwrite()"]');
    try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        console.log("Handwrite Firebase åˆå§‹åŒ–æˆåŠŸï¼");
    } catch(e) {
        console.error("Handwrite Firebase åˆå§‹åŒ–å¤±æ•—ï¼", e);
        alert("éŒ¯èª¤ï¼šç„¡æ³•é€£æ¥å¾Œç«¯æœå‹™ï¼æ‰‹å¯«å…§å®¹å°‡ç„¡æ³•ä¸Šå‚³ã€‚");
        if(uploadButton) { uploadButton.disabled = true; uploadButton.textContent = 'é€£ç·šå¤±æ•—'; uploadButton.style.backgroundColor = 'grey'; }
    }

    // 4. å–å¾—ç•«é¢å…ƒç´ å’Œè¨­å®š Canvas
    const canvas = document.getElementById('handwriteCanvas');
    const ctx = canvas.getContext('2d', { alpha: false }); // alpha:false æé«˜æ•ˆèƒ½ (å¦‚æœä¸éœ€è¦é€æ˜åº¦)
    const uploadStatusDiv = document.getElementById('uploadStatus');
    const previewImage = document.getElementById('previewImage');
    const pageTitleElement = document.getElementById('pageTitle'); // ä½¿ç”¨ ID ç²å–
    let drawing = false;
    let hasContent = false; // è¿½è¹¤æ˜¯å¦æœ‰ç­†è·¡

    // --- Canvas å¤§å°è‡ªé©æ‡‰ ---
    function resizeCanvas() {
        const maxWidth = window.innerWidth * 0.95; // æœ€å¤§å¯¬åº¦ç‚ºè¦–çª—çš„ 95%
        const maxHeight = window.innerHeight * 0.6; // æœ€å¤§é«˜åº¦ç‚ºè¦–çª—çš„ 60% (ç•™ç©ºé–“çµ¦æŒ‰éˆ•ç­‰)
        const defaultSize = 320; // é è¨­å¤§å°
        const size = Math.min(maxWidth, maxHeight, defaultSize); // å–æœ€å°å€¼

        // æª¢æŸ¥ Canvas æ˜¯å¦å·²ç¶“å­˜åœ¨å¯¬é«˜ï¼Œå¦‚æœæ”¹è®Šäº†æ‰é‡è¨­ä¸¦é‡ç¹ª
        if (canvas.width !== size || canvas.height !== size) {
            // ä¿å­˜ç•¶å‰å…§å®¹
            const currentImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            canvas.width = size;
            canvas.height = size;

            // æ¢å¾©å…§å®¹ (å¦‚æœéœ€è¦ï¼Œä½†é€šå¸¸é‡è¨­å¤§å°å¾Œéœ€è¦é‡ç¹ªèƒŒæ™¯)
            // ctx.putImageData(currentImageData, 0, 0);
             console.log(`Canvas resized to ${size}x${size}. Reinitializing...`);
             // é‡æ–°åˆå§‹åŒ–ç•«å¸ƒ (æœƒé‡ç¹ªèƒŒæ™¯)
             initializeCanvas();
        }
    }
    // åˆå§‹èª¿æ•´ä¸€æ¬¡ï¼Œä¸¦ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
    // resizeCanvas(); // åœ¨ initializeCanvas ä¹‹å‰èª¿ç”¨å¯èƒ½å°è‡´èƒŒæ™¯ç¹ªè£½å•é¡Œï¼Œç§»åˆ°å¾Œé¢
    // window.addEventListener('resize', resizeCanvas); // resize äº‹ä»¶å¯èƒ½éæ–¼é »ç¹ï¼Œæš«ä¸å•Ÿç”¨

    // 5. è®€å– URL åƒæ•¸
    const urlParams = new URLSearchParams(window.location.search);
    const backgroundUrl = urlParams.get('backgroundUrl');
    let questionId = urlParams.get('questionId'); // å¯è¢«è¦†è“‹
    const studentIdFromUrl = urlParams.get('studentId');

    // ç²å–å­¸ç”Ÿè³‡è¨Š
    const studentId = studentIdFromUrl || sessionStorage.getItem("studentId") || "guest_" + Date.now(); // çµ¦ guest åŠ æ™‚é–“æˆ³
    const studentName = sessionStorage.getItem("studentName") || "åŒ¿åå­¸ç”Ÿ";

    console.log(`æ‰‹å¯«é é¢: studentId=${studentId}, initial_questionId=${questionId}, hasBackground=${!!backgroundUrl}`);

    // 6. åˆå§‹åŒ–ç•«å¸ƒ (ç¹ªè£½èƒŒæ™¯æˆ–æ¸…ç©º)
    let isBackgroundLoading = false; // æ¨™è¨˜èƒŒæ™¯æ˜¯å¦æ­£åœ¨è¼‰å…¥
    function initializeCanvas() {
        isBackgroundLoading = false; // é‡è¨­æ¨™è¨˜
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        hasContent = false;
        // é è¨­ç™½è‰²èƒŒæ™¯
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (backgroundUrl) {
            console.log("æº–å‚™è¼‰å…¥èƒŒæ™¯åœ–:", backgroundUrl);
            if (pageTitleElement) pageTitleElement.innerText = 'ğŸ“ æ™ºæ…§è¨»è¨˜ (è¼‰å…¥ä¸­...)';
            isBackgroundLoading = true;
            const img = new Image();
            img.crossOrigin = "Anonymous"; // éå¸¸é‡è¦ï¼Œå¦å‰‡ toDataURL å¯èƒ½æœƒå› å®‰å…¨å•é¡Œå¤±æ•—
            img.onload = function() {
                isBackgroundLoading = false;
                console.log("èƒŒæ™¯åœ–è¼‰å…¥æˆåŠŸï¼Œç¹ªè£½...");
                if (pageTitleElement) pageTitleElement.innerText = 'ğŸ“ æ™ºæ…§è¨»è¨˜æ¨¡å¼';
                try {
                    // æ¸…é™¤é è¨­ç™½è‰²èƒŒæ™¯ï¼Œç¹ªè£½åœ–ç‰‡
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    console.log("èƒŒæ™¯åœ–ç¹ªè£½å®Œæˆã€‚");
                } catch (drawError) {
                     console.error("ç¹ªè£½èƒŒæ™¯åœ–å¤±æ•—:", drawError); alert("éŒ¯èª¤ï¼šç„¡æ³•ç¹ªè£½èƒŒæ™¯åœ–ã€‚");
                     ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, canvas.width, canvas.height); // æ¢å¾©ç™½è‰²èƒŒæ™¯
                     if (pageTitleElement) pageTitleElement.innerText = 'âš ï¸ èƒŒæ™¯ç¹ªè£½å¤±æ•—';
                }
            };
            img.onerror = function(e) {
                isBackgroundLoading = false;
                console.error("è¼‰å…¥èƒŒæ™¯åœ–å¤±æ•—:", backgroundUrl, e); alert("éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥è€å¸«æä¾›çš„èƒŒæ™¯åœ–ã€‚");
                if (pageTitleElement) pageTitleElement.innerText = 'âš ï¸ èƒŒæ™¯è¼‰å…¥å¤±æ•—';
                // ä¸éœ€è¦å†ç•«ç™½è‰²èƒŒæ™¯ï¼Œå› ç‚ºåˆå§‹æ™‚å·²ç¶“ç•«äº†
            };
            try { img.src = decodeURIComponent(backgroundUrl); }
            catch (uriError) { isBackgroundLoading = false; console.error("èƒŒæ™¯åœ– URL è§£ç¢¼å¤±æ•—:", uriError); alert("éŒ¯èª¤ï¼šèƒŒæ™¯åœ–é€£çµæ ¼å¼éŒ¯èª¤ã€‚"); if (pageTitleElement) pageTitleElement.innerText = 'âš ï¸ èƒŒæ™¯é€£çµéŒ¯èª¤'; }
        } else {
            console.log("ç„¡èƒŒæ™¯åœ–ï¼Œè‡ªç”±ç¹ªåœ–æ¨¡å¼ã€‚");
            if (pageTitleElement) pageTitleElement.innerText = 'ğŸ¨ è‡ªç”±ç¹ªåœ–æ¨¡å¼';
            // ç™½è‰²èƒŒæ™¯å·²åœ¨å‡½æ•¸é–‹é ­ç¹ªè£½
        }
        if(previewImage) previewImage.style.display = "none";
        if(uploadStatusDiv) uploadStatusDiv.textContent = "";
    }

    // 7. Canvas ç¹ªåœ–äº‹ä»¶è™•ç†å‡½æ•¸
    function getCanvasPos(e) { const rect = canvas.getBoundingClientRect(); const touch = e.touches?.[0]; return { x: touch ? touch.clientX - rect.left : e.offsetX, y: touch ? touch.clientY - rect.top : e.offsetY }; }
    function startDraw(e) { if(isBackgroundLoading) return; e.preventDefault(); drawing = true; hasContent = true; const pos = getCanvasPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
    function draw(e) { if (!drawing || isBackgroundLoading) return; e.preventDefault(); const pos = getCanvasPos(e); ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#000000'; ctx.lineTo(pos.x, pos.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
    function endDraw(e) { if (!drawing) return; e.preventDefault(); drawing = false; ctx.beginPath(); }

    // 8. ç¶å®šäº‹ä»¶ç›£è½å™¨
    canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', endDraw); canvas.addEventListener('mouseout', endDraw);
    canvas.addEventListener('touchstart', startDraw, { passive: false }); canvas.addEventListener('touchmove', draw, { passive: false }); canvas.addEventListener('touchend', endDraw); canvas.addEventListener('touchcancel', endDraw);

    // 9. æŒ‰éˆ•åŠŸèƒ½å‡½æ•¸
    window.clearCanvas = function () { if(isBackgroundLoading) return; if (!confirm("ç¢ºå®šæ¸…é™¤ç­†è·¡ï¼ŸèƒŒæ™¯å°‡ä¿ç•™ã€‚")) return; console.log("æ¸…é™¤ç­†è·¡..."); initializeCanvas(); }
    window.uploadHandwrite = async function () {
       if (!db) { alert("éŒ¯èª¤ï¼šæœªé€£æ¥æœå‹™ï¼Œç„¡æ³•ä¸Šå‚³ã€‚"); return; }
       if (!hasContent) { alert("è«‹å…ˆç•«é»æ±è¥¿ï¼"); return; }
       if (isBackgroundLoading) { alert("èƒŒæ™¯æ­£åœ¨è¼‰å…¥ï¼Œè«‹ç¨å€™å†ä¸Šå‚³ã€‚"); return; }

       const finalQuestionId = questionId || `è‡ªç”±ç¹ªåœ–_${Date.now()}`;
       console.log(`æº–å‚™ä¸Šå‚³: studentId=${studentId}, questionId=${finalQuestionId}`);

       let imageUrl;
       try { imageUrl = canvas.toDataURL("image/png"); }
       catch (e) { console.error("Canvas toDataURL å¤±æ•—:", e); alert("éŒ¯èª¤ï¼šç„¡æ³•è½‰æ›ç¹ªåœ–ã€‚"); return; }
       if (imageUrl.length > 2 * 1024 * 1024) { console.warn("åœ–ç‰‡ Data URL éé•·"); alert("è­¦å‘Šï¼šç¹ªåœ–éå¤§ï¼Œå¯èƒ½ç„¡æ³•å„²å­˜ã€‚"); }

       const data = { studentId, studentName, questionId: finalQuestionId, imageUrl, hasBackground: !!backgroundUrl, timestamp: Date.now() };
       const refPath = ref(db, `handwriting/${studentId}/${finalQuestionId}`);

       if (uploadStatusDiv) { uploadStatusDiv.style.color = "#555"; uploadStatusDiv.textContent = "ğŸ“¤ ä¸Šå‚³ä¸­..."; }
       if (previewImage) previewImage.style.display = "none";
       if (uploadButton) uploadButton.disabled = true; // ç¦ç”¨æŒ‰éˆ•

       try {
         await set(refPath, data);
         console.log("æ‰‹å¯«ä¸Šå‚³æˆåŠŸï¼");
         if (uploadStatusDiv) { uploadStatusDiv.style.color = "green"; uploadStatusDiv.textContent = "âœ… ä¸Šå‚³æˆåŠŸï¼"; }
         if (previewImage) { previewImage.src = imageUrl; previewImage.style.display = "block"; }
         // æç¤ºä¸¦å»¶é²é—œé–‰
         alert("ä½œç­”å·²æˆåŠŸä¸Šå‚³ï¼æ­¤è¦–çª—å°‡åœ¨ 3 ç§’å¾Œè‡ªå‹•é—œé–‰ã€‚");
         setTimeout(() => { window.close(); }, 3000);

       } catch (e) {
         console.error("âŒ ä¸Šå‚³æ‰‹å¯«åˆ° Firebase å¤±æ•—ï¼š", e);
         if (uploadStatusDiv) { uploadStatusDiv.style.color = "red"; uploadStatusDiv.textContent = "âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦"; }
         alert("âŒ ä¸Šå‚³å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œé‡è©¦ã€‚");
         if (uploadButton) uploadButton.disabled = false; // ç™¼ç”ŸéŒ¯èª¤æ™‚æ¢å¾©æŒ‰éˆ•
       }
    }

    // 10. é é¢è¼‰å…¥æ™‚åŸ·è¡Œåˆå§‹åŒ–å’Œé¦–æ¬¡ Canvas èª¿æ•´
    // resizeCanvas(); // å…ˆèª¿æ•´å¤§å°
    initializeCanvas(); // å†åˆå§‹åŒ–å…§å®¹å’ŒèƒŒæ™¯

  </script>
</body>
</html>
<!-- END OF FILE handwrite-upload.html (v2 - æ”¯æ´èƒŒæ™¯åœ–èˆ‡ç¨ç«‹é‹ä½œ) -->
