<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智慧手寫作答系統 - 白貓工作室</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      text-align: center;
      background-color: #f9f9f9;
      padding: 20px;
      margin: 0;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    #info {
      margin-bottom: 20px;
      font-size: 18px;
      color: #333;
    }
    canvas {
      border: 2px solid #ccc;
      margin-top: 10px;
      background: #ffffff;
      touch-action: none;
    }
    .tools, .submit-btn {
      margin-top: 15px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background-color: #ffa726;
      color: white;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #fb8c00;
    }
  </style>
</head>
<body>

  <h1>✏️ 智慧手寫作答系統</h1>

  <div id="info">
    <div id="studentInfo"></div>
    <div id="questionInfo"></div>
  </div>

  <canvas id="handwriteCanvas" width="300" height="300"></canvas>

  <div class="tools">
    <button type="button" onclick="clearCanvas()">🧹 清除畫布</button>
  </div>

  <div class="submit-btn">
    <button type="button" onclick="uploadHandwrite()">📤 上傳作答</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBB3wmBveYumzmPUQuIr4ApZYxKnnT-IdA",
      authDomain: "catclassroom-login.firebaseapp.com",
      databaseURL: "https://catclassroom-login-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "catclassroom-login",
      storageBucket: "catclassroom-login.appspot.com",
      messagingSenderId: "123487233181",
      appId: "1:123487233181:web:aecc2891dc2d1096962074",
      measurementId: "G-6C92GYSX3F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const studentId = sessionStorage.getItem("studentId");
    let studentName = "";
    let studentClass = "";
    let questionId = "";
    let releaseTimestamp = 0;

    const studentInfoDiv = document.getElementById("studentInfo");
    const questionInfoDiv = document.getElementById("questionInfo");

    // 抓學生資料
    if (studentId) {
      const loginRef = ref(db, `login/${studentId}`);
      get(loginRef).then(snapshot => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          studentName = data.StudentName || "";
          studentClass = data.StudentClass || "";
          studentInfoDiv.textContent = `👤 ${studentClass} ${studentName}`;
        }
      });
    }

    // 抓題目資料
    const questionRef = ref(db, `teacher/question`);
    get(questionRef).then(snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        questionId = data.id || "";
        releaseTimestamp = data.timestamp || 0;
        if (questionId) {
          questionInfoDiv.textContent = `✏️ 題目：${questionId}`;
        }
      }
    });

    // 畫布設定
    const canvas = document.getElementById('handwriteCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function startDraw(e) {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    }

    function draw(e) {
      if (!drawing) return;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
    }

    function endDraw() {
      drawing = false;
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseout', endDraw);

    window.clearCanvas = function () {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // 上傳作答
    window.uploadHandwrite = async function () {
      if (!studentId || !questionId) {
        alert("❌ 資料不足，無法上傳");
        return;
      }

      const now = Date.now();
      if (releaseTimestamp && now - releaseTimestamp > 5 * 60 * 1000) {
        alert("⏰ 作答時間已過，無法上傳");
        return;
      }

      const imageUrl = canvas.toDataURL("image/png");

      const data = {
        studentId,
        studentName,
        studentClass,
        questionId,
        imageUrl,
        fromCanvas: true,
        timestamp: now
      };

      try {
        await set(ref(db, `handwriting/${studentId}/${questionId}`), data);
        alert("✅ 作答上傳成功！");
      } catch (error) {
        alert("❌ 上傳失敗：" + error.message);
      }
    }

  </script>

</body>
</html>
