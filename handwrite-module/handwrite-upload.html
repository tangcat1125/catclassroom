<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智慧手寫作答系統 - 白貓工作室</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      text-align: center;
      background-color: #f9f9f9;
      padding: 20px;
      margin: 0;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    #info, #questionBlock {
      margin-bottom: 20px;
      font-size: 18px;
      color: #333;
    }
    #questionContent {
      margin: 10px auto;
      padding: 10px;
      max-width: 500px;
      border: 2px solid #ccc;
      border-radius: 8px;
      background-color: #ffffff;
      white-space: pre-wrap;
    }
    #controls {
      margin-bottom: 10px;
    }
    canvas {
      border: 2px solid #ccc;
      margin-top: 10px;
      background: #ffffff;
      touch-action: none;
    }
    .tools, .submit-btn {
      margin-top: 15px;
    }
    button, select {
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background-color: #ffa726;
      color: white;
      transition: background-color 0.3s;
      margin: 5px;
    }
    button:hover {
      background-color: #fb8c00;
    }
    #uploadStatus {
      margin-top: 15px;
      font-size: 18px;
      color: #28a745;
    }
    #previewImage {
      margin-top: 15px;
      max-width: 150px;
      border: 1px solid #aaa;
    }
  </style>
</head>
<body>

  <h1>✏️ 智慧手寫作答系統</h1>

  <div id="info">
    <div id="studentInfo"></div>
  </div>

  <div id="questionBlock" style="display:none;">
    <div id="questionInfo"></div>
    <div id="questionContent"></div>
  </div>

  <div id="controls">
    <select id="colorPicker">
      <option value="#000000">黑色</option>
      <option value="#ff0000">紅色</option>
      <option value="#0000ff">藍色</option>
    </select>
    <select id="lineWidthPicker">
      <option value="2">細線</option>
      <option value="5">中線</option>
      <option value="8">粗線</option>
    </select>
  </div>

  <canvas id="handwriteCanvas" width="300" height="300"></canvas>

  <div class="tools">
    <button type="button" onclick="clearCanvas()">🧹 清除畫布</button>
  </div>

  <div class="submit-btn">
    <button type="button" onclick="uploadHandwrite()">📤 上傳作答</button>
  </div>

  <div id="uploadStatus"></div>
  <img id="previewImage" style="display:none;" />

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBB3wmBveYumzmPUQuIr4ApZYxKnnT-IdA",
      authDomain: "catclassroom-login.firebaseapp.com",
      databaseURL: "https://catclassroom-login-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "catclassroom-login",
      storageBucket: "catclassroom-login.appspot.com",
      messagingSenderId: "123487233181",
      appId: "1:123487233181:web:aecc2891dc2d1096962074",
      measurementId: "G-6C92GYSX3F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const studentId = sessionStorage.getItem("studentId") || "test";
    let studentName = "";
    let studentClass = "";
    let questionId = "";
    let releaseTimestamp = 0;

    const studentInfoDiv = document.getElementById("studentInfo");
    const questionInfoDiv = document.getElementById("questionInfo");
    const questionContentDiv = document.getElementById("questionContent");
    const questionBlockDiv = document.getElementById("questionBlock");
    const uploadStatusDiv = document.getElementById("uploadStatus");
    const previewImage = document.getElementById("previewImage");

    // 抓學生資料
    const loginRef = ref(db, `login/${studentId}`);
    get(loginRef).then(snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        studentName = data.StudentName || "";
        studentClass = data.StudentClass || "";
        studentInfoDiv.textContent = `👤 ${studentClass} ${studentName}`;
      }
    });

    // 抓題目資料
    const questionRef = ref(db, `teacher/question`);
    get(questionRef).then(snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        questionId = data.id || "";
        releaseTimestamp = data.timestamp || 0;
        const questionText = data.content || "";

        if (questionId) {
          questionInfoDiv.textContent = `✏️ 題目：${questionId}`;
        }
        if (questionText) {
          questionContentDiv.textContent = questionText;
          questionBlockDiv.style.display = "block";
        }
      }
    });

    // 畫布設定
    const canvas = document.getElementById('handwriteCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function startDraw(e) {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    }

    function draw(e) {
      if (!drawing) return;
      ctx.lineWidth = document.getElementById('lineWidthPicker').value;
      ctx.lineCap = 'round';
      ctx.strokeStyle = document.getElementById('colorPicker').value;
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
    }

    function endDraw() {
      drawing = false;
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseout', endDraw);

    window.clearCanvas = function () {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      previewImage.style.display = "none";
    }

    // 上傳作答
    window.uploadHandwrite = async function () {
      if (!studentId || !questionId) {
        alert("❌ 資料不足，無法上傳");
        return;
      }

      const now = Date.now();
      if (releaseTimestamp && now - releaseTimestamp > 5 * 60 * 1000) {
        alert("⏰ 作答時間已過，無法上傳");
        return;
      }

      const imageUrl = canvas.toDataURL("image/png");
      uploadStatusDiv.style.color = "#007bff";
      uploadStatusDiv.textContent = "📤 上傳中...請稍候";

      const data = {
        studentId,
        studentName,
        studentClass,
        questionId,
        imageUrl,
        fromCanvas: true,
        timestamp: now
      };

      try {
        await set(ref(db, `handwriting/${studentId}/${questionId}`), data);
        uploadStatusDiv.style.color = "#28a745";
        uploadStatusDiv.textContent = "✅ 作答上傳成功！以下是你的畫作預覽：";
        previewImage.src = imageUrl;
        previewImage.style.display = "block";
      } catch (error) {
        uploadStatusDiv.style.color = "#dc3545";
        uploadStatusDiv.textContent = "❌ 上傳失敗，請再試一次！";
      }
    }

  </script>

</body>
</html>
