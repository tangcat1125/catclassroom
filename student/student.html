<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç”Ÿä½œç­”å€</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* è¤‡è£½æ‚¨æä¾›çš„åŸå§‹ CSS æ¨£å¼ */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #e9ebee;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            padding: 20px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            color: #1d2129;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .info-bar, .message-box, .sos-box, .chat-box {
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        .info-bar {
            background-color: #e7f3ff;
            border: 1px solid #cce0ff;
            color: #004085;
            font-weight: bold;
        }
        .message-box {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            min-height: 60px;
        }
        .message-box .title {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        .sos-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            display: flex;
            justify-content: center;
        }
        #sosButton {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .chat-box {
            background-color: #f0e6ff;
            border: 1px solid #d8c4f7;
        }
        .chat-box .title {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            color: #495057;
        }
        #chatMessages {
            height: 150px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid #ced4da;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            line-height: 1.4;
            color: #333;
        }
        #chatMessages p {
            margin: 0 0 8px 0;
        }
        #interactionArea {
            display: flex;
            gap: 10px;
        }
        #chatInput {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            resize: none;
        }
        #sendButton {
            padding: 10px 15px;
            background-color: #6f42c1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }
        .answer-button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 1.1em;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .answer-button:hover {
            background-color: #e2e6ea;
        }
        .cat-decoration {
            position: fixed;
            bottom: 15px;
            right: 15px;
            width: 50px;
            height: auto;
            opacity: 0.8;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>å­¸ç”Ÿä½œç­”å€</h1>

        <div class="info-bar" id="studentInfoBar">
            ç­ç´šï¼š<span id="infoClass">è®€å–ä¸­...</span> |
            åº§è™Ÿï¼š<span id="infoSeat">è®€å–ä¸­...</span> |
            å§“åï¼š<span id="infoName">è®€å–ä¸­...</span>
        </div>

        <div class="message-box" id="systemMessageBox">
            <span class="title">ğŸ“¢ ç³»çµ±è¨Šæ¯</span>
            <div id="systemMessageContent">ç­‰å¾…è€å¸«æŒ‡ä»¤ä¸­...</div>
        </div>

        <div class="sos-box">
            <button id="sosButton">ğŸ†˜ æˆ‘è¦æ±‚æ•‘</button>
        </div>

        <div class="chat-box">
            <span class="title">ğŸ“ èª²ç¨‹èŠå¤©å®¤ / ä½œç­”å€</span>
            <div id="chatMessages">
                <p style="color: #888;">(èŠå¤©å®¤è®€å–ä¸­...)</p>
            </div>
            <div id="interactionArea">
                <textarea id="chatInput" placeholder="è¼¸å…¥èŠå¤©å®¤è¨Šæ¯..." rows="2"></textarea>
                <button id="sendButton">é€å‡º</button>
            </div>
        </div>
    </div>

    <script>
        // student.js - å­¸ç”Ÿä½œç­”å€é é¢è…³æœ¬
        // åŠŸèƒ½ï¼šé¡¯ç¤ºå­¸ç”Ÿè³‡è¨Šã€ç›£è½èŠå¤©è¨Šæ¯ã€ç™¼é€èŠå¤©è¨Šæ¯ã€æ±‚æ•‘åŠŸèƒ½

        // å°å…¥ Firebase SDK (ä½¿ç”¨ CDN æ–¹å¼)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› API é‡‘é‘°
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // è«‹æ›¿æ›ç‚ºæ‚¨çš„å°ˆæ¡ˆ ID
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.asia-southeast1.firebasedatabase.app", // è«‹æ›¿æ›ç‚ºæ‚¨çš„è³‡æ–™åº« URL
            projectId: "YOUR_PROJECT_ID", // è«‹æ›¿æ›ç‚ºæ‚¨çš„å°ˆæ¡ˆ ID
            storageBucket: "YOUR_PROJECT_ID.appspot.com", // è«‹æ›¿æ›ç‚ºæ‚¨çš„å„²å­˜æ¡¶åç¨±
            messagingSenderId: "YOUR_SENDER_ID", // è«‹æ›¿æ›ç‚ºæ‚¨çš„è¨Šæ¯å¯„ä»¶è€… ID
            appId: "YOUR_APP_ID", // è«‹æ›¿æ›ç‚ºæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ ID
            measurementId: "YOUR_MEASUREMENT_ID" // è«‹æ›¿æ›ç‚ºæ‚¨çš„è©•ä¼° ID
        };

        // åˆå§‹åŒ– Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        console.log("[Firebase] åˆå§‹åŒ–æˆåŠŸï¼");

        // å…¨åŸŸè®Šæ•¸
        let studentInfo = null;
        let currentQuestionId = 'question1';

        /**
         * å¾ localStorage è®€å–å­¸ç”Ÿè³‡è¨Š
         * å¦‚æœè³‡è¨Šä¸å­˜åœ¨æˆ–æ ¼å¼éŒ¯èª¤ï¼Œå°‡é‡æ–°å°å‘åˆ°ç™»å…¥é é¢
         */
        function getStudentInfo() {
            const storedStudentInfo = localStorage.getItem('studentInfo');
            if (!storedStudentInfo) {
                console.warn("[LocalStorage] æœªæ‰¾åˆ°å­¸ç”Ÿè³‡è¨Šï¼Œé‡æ–°å°å‘åˆ°ç™»å…¥é é¢ã€‚");
                redirectToLogin();
                return null;
            }

            try {
                const parsedInfo = JSON.parse(storedStudentInfo);
                if (!parsedInfo || typeof parsedInfo !== 'object' ||
                    !parsedInfo.classType || !parsedInfo.name || !parsedInfo.seat) {
                    throw new Error("å„²å­˜çš„å­¸ç”Ÿè³‡è¨Šæ ¼å¼éŒ¯èª¤ã€‚");
                }
                return parsedInfo;
            } catch (error) {
                console.error("[LocalStorage] è§£æå­¸ç”Ÿè³‡è¨Šå¤±æ•—:", error);
                localStorage.removeItem('studentInfo');
                redirectToLogin();
                return null;
            }
        }

        /**
         * å°‡ä½¿ç”¨è€…é‡æ–°å°å‘åˆ°ç™»å…¥é é¢
         */
        function redirectToLogin() {
            alert("è«‹å…ˆç™»å…¥ã€‚");
            window.location.href = 'index.html';
        }

        /**
         * æ›´æ–°é ‚éƒ¨è³‡è¨Šæ¬„çš„ UI å…ƒç´ 
         * @param {object} studentInfo - åŒ…å«ç­ç´šã€åº§è™Ÿå’Œå§“åçš„å­¸ç”Ÿè³‡è¨Šç‰©ä»¶
         */
        function updateTopInfo(studentInfo) {
            const infoClassElement = document.getElementById('infoClass');
            const infoSeatElement = document.getElementById('infoSeat');
            const infoNameElement = document.getElementById('infoName');

            if (!infoClassElement || !infoSeatElement || !infoNameElement) {
                const errorMessage = "[DOM] éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é ‚éƒ¨è³‡è¨Šæ¬„çš„ span å…ƒç´ ã€‚";
                console.error(errorMessage);
                alert("é é¢çµæ§‹éŒ¯èª¤ï¼Œç„¡æ³•é¡¯ç¤ºå­¸ç”Ÿè³‡è¨Šã€‚è«‹è¯çµ¡ç®¡ç†å“¡ã€‚");
                return;
            }

            infoClassElement.textContent = studentInfo.classType;
            infoSeatElement.textContent = studentInfo.seat;
            infoNameElement.textContent = studentInfo.name;
            console.log("[UI] é ‚éƒ¨è³‡è¨Šæ¬„å·²æ›´æ–°ã€‚");
        }

        /**
         * è¨­å®šèŠå¤©è¨Šæ¯çš„ç›£è½å™¨
         * @param {string} questionId - è¦ç›£è½çš„é¡Œç›® ID
         */
        function setupChatListener(questionId) {
            const chatRef = firebase.database().ref(`chat/${questionId}`);
            chatRef.on('value', (snapshot) => {
                const messages = snapshot.val();
                const chatMessagesElement = document.getElementById('chatMessages');
                if (!chatMessagesElement) {
                    console.error("[DOM] éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°èŠå¤©è¨Šæ¯é¡¯ç¤ºå€åŸŸã€‚");
                    return;
                }

                chatMessagesElement.innerHTML = '';
                if (messages) {
                    Object.values(messages).forEach(msg => {
                        const messageElement = document.createElement('p');
                        messageElement.innerHTML = `<strong>${msg.name}:</strong> ${msg.text} <small>(${new Date(msg.timestamp).toLocaleTimeString()})</small>`;
                        chatMessagesElement.appendChild(messageElement);
                    });
                    chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;
                } else {
                    chatMessagesElement.innerHTML = '<p style="color: #888;">(èŠå¤©å®¤å°šç„¡è¨Šæ¯...)</p>';
                }
            }, (error) => {
                console.error("[Chat] ç›£è½éŒ¯èª¤:", error);
                alert(`èŠå¤©è¨Šæ¯ç›£è½ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`);
            });
        }

        /**
         * ç™¼é€èŠå¤©è¨Šæ¯åˆ° Firebase
         * @param {string} text - è¦ç™¼é€çš„è¨Šæ¯å…§å®¹
         * @param {string} senderName - ç™¼é€è€…çš„å§“å
         */
        function sendChatMessage(text, senderName, questionId) {
            const chatRef = firebase.database().ref(`chat/${questionId}`);
            chatRef.push({
                name: senderName,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                console.log("[Chat] è¨Šæ¯ç™¼é€æˆåŠŸ");
            }).catch(error => {
                console.error("[Chat] ç™¼é€å¤±æ•—:", error);
                alert(`ç™¼é€è¨Šæ¯å¤±æ•—ï¼š${error.message}`);
            });
        }

        /**
         * è™•ç†æ±‚æ•‘æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶ï¼Œä¸¦å°‡æ±‚æ•‘è¨Šè™Ÿç™¼é€åˆ° Firebase
         * @param {string} studentName - ç™¼é€æ±‚æ•‘è¨Šè™Ÿçš„å­¸ç”Ÿå§“å
         * @param {number} studentSeat - ç™¼é€æ±‚æ•‘è¨Šè™Ÿçš„å­¸ç”Ÿåº§è™Ÿ
         */
        function sendSOSSignal(studentName, studentSeat) {
            const helpRef = firebase.database().ref(`help/${studentSeat}`);
            helpRef.set({
                name: studentName,
                seat: studentSeat,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                alert('æ±‚æ•‘è¨Šè™Ÿå·²ç™¼é€ï¼');
                console.log("[SOS] æ±‚æ•‘è¨Šè™Ÿç™¼é€æˆåŠŸ");
            }).catch(error => {
                console.error("[SOS] ç™¼é€å¤±æ•—:", error);
                alert(`ç™¼é€æ±‚æ•‘è¨Šè™Ÿå¤±æ•—ï¼š${error.message}`);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("[DOM] student.html æ–‡ä»¶è¼‰å…¥å®Œæˆ.");

            // ç²å–å­¸ç”Ÿè³‡è¨Š
            studentInfo = getStudentInfo();
            if (!studentInfo) {
                return;
            }

            // æ›´æ–°é ‚éƒ¨è³‡è¨Šæ¬„
            updateTopInfo(studentInfo);

            // ç²å–èŠå¤©å’Œæ±‚æ•‘ç›¸é—œçš„ DOM å…ƒç´ 
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const sosButton = document.getElementById('sosButton');

            if (!chatInput || !sendButton || !sosButton) {
                console.error("[DOM] éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°èŠå¤©æˆ–æ±‚æ•‘ç›¸é—œå…ƒç´ ã€‚");
                return;
            }

            // åˆå§‹åŒ–èŠå¤©ç›£è½å™¨
            setupChatListener(currentQuestionId);

            // èŠå¤©åŠŸèƒ½ï¼šç™¼é€è¨Šæ¯
            sendButton.addEventListener('click', () => {
                const text = chatInput.value.trim();
                if (text) {
                    sendChatMessage(text, studentInfo.name, currentQuestionId);
                    chatInput.value = '';
                } else {
                    alert("è«‹è¼¸å…¥è¨Šæ¯ï¼");
                }
            });

            // æ”¯æ´ Enter éµç™¼é€è¨Šæ¯
            chatInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendButton.click();
                }
            });

            // æ±‚æ•‘åŠŸèƒ½
            sosButton.addEventListener('click', () => {
                sendSOSSignal(studentInfo.name, studentInfo.seat);
            });

            // å‹•æ…‹ç›£è½é¡Œç›® ID
             const questionRef = firebase.database().ref('teacher/currentQuestion');
            questionRef.on('value', (snapshot) => {
                const question = snapshot.val();
                if (question && question.id) {
                    console.log("[Question] ç•¶å‰é¡Œç›® ID:", question.id);
                    currentQuestionId = question.id;
                    setupChatListener(currentQuestionId);
                }
            }, (error) => {
                console.error("[Question] ç›£è½é¡Œç›®æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                alert(`ç„¡æ³•ç²å–ç•¶å‰é¡Œç›®ï¼š${error.message}ã€‚è«‹é‡æ–°æ•´ç†é é¢ã€‚`);
            });
        });
    </script>
</body>
</html>
