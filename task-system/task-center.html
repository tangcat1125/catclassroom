<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>派題中心 - 白貓工作室</title>
  <link rel="stylesheet" href="../task-system/task-style.css">
</head>
<body>

  <header>
    <div class="wizard-section">
      <p>🪄 這裡有出題小精靈可以幫你快速新增題目喔！</p>
      <button onclick="window.location.href='task-editor.html'">🪄 開啟出題小精靈</button>
    </div>

    <h1>派題中心 - 白貓工作室</h1>

    <div class="filter-section">
      <h3>🔍 題目篩選器</h3>

      <label>出題日期：</label>
      <input type="date" id="filterDate">

      <label>學程：</label>
      <select id="filterCourseLevel">
        <option value="">全部</option>
        <option value="國小中年級">國小中年級</option>
        <option value="國小高年級">國小高年級</option>
        <option value="國中">國中</option>
        <option value="高中">高中</option>
      </select>

      <label>科目：</label>
      <select id="filterSubject">
        <option value="">全部</option>
        <option value="國語">國語</option>
        <option value="數學">數學</option>
        <option value="自然">自然</option>
        <option value="社會">社會</option>
        <option value="英文">英文</option>
        <option value="其他">其他</option>
      </select>

      <button id="filterBtn">🔎 篩選題目</button>
    </div>
  </header>

  <main>
    <section class="question-bank">
      <h2>題目清單</h2>
      <div id="questionList">
        <!-- 題目列表 -->
      </div>
    </section>
  </main>

  <script type="module">
    import { taskDatabase } from "./firebase-config-task.js";
    import { ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
    import { uploadCurrentQuestion } from "./task-database.js";

    const questionListDiv = document.getElementById('questionList');
    const filterDateInput = document.getElementById('filterDate');
    const filterCourseLevelSelect = document.getElementById('filterCourseLevel');
    const filterSubjectSelect = document.getElementById('filterSubject');
    const filterBtn = document.getElementById('filterBtn');

    let allQuestions = [];
    let filteredQuestions = [];

    filterBtn.addEventListener('click', updateFilter);

    function updateFilter() {
      const filterDate = filterDateInput.value;
      const filterCourseLevel = filterCourseLevelSelect.value;
      const filterSubject = filterSubjectSelect.value;

      filteredQuestions = allQuestions.filter(q => {
        const matchDate = filterDate ? q.date === filterDate : true;
        const matchCourse = filterCourseLevel ? q.courseLevel === filterCourseLevel : true;
        const matchSubject = filterSubject ? q.subject === filterSubject : true;
        return matchDate && matchCourse && matchSubject;
      });

      updateQuestionList();
    }

    function updateQuestionList() {
      questionListDiv.innerHTML = '';

      if (filteredQuestions.length === 0) {
        questionListDiv.innerHTML = '<p>找不到符合條件的題目，請調整篩選條件。</p>';
        return;
      }

      filteredQuestions.forEach((q, index) => {
        const qDiv = document.createElement('div');
        qDiv.className = 'question-item';
        qDiv.innerHTML = `
          <strong>題${index + 1}:</strong> ${q.text}<br>
          <button onclick="assignQuestion(${index})">📤 派送這題</button> 
          <button onclick="assignHandwriteQuestion(${index})">✏️ 手寫派題</button>
          <hr>
        `;
        questionListDiv.appendChild(qDiv);
      });
    }

    // 派送到 /currentQuestion（一般出題）
    window.assignQuestion = function(index) {
      const question = filteredQuestions[index];
      if (!question) {
        alert('題目不存在！');
        return;
      }
      uploadCurrentQuestion(question);
      alert(`✅ 已將題${index + 1}派送給班級！`);
    }

    // 派送到 /teacher/question（手寫作答）
    window.assignHandwriteQuestion = function(index) {
      const question = filteredQuestions[index];
      if (!question) {
        alert('題目不存在！');
        return;
      }

      const now = Date.now();
      const handwriteData = {
        id: question.id || `Q-${now}`,
        timestamp: now,
        content: question.text
      };

      const teacherQuestionRef = ref(taskDatabase, '/teacher/question');
      set(teacherQuestionRef, handwriteData)
        .then(() => {
          alert(`✅ 已派送到手寫作答系統！`);
        })
        .catch((error) => {
          console.error('❌ 派送失敗：', error);
          alert('派送失敗，請查看主控台(console)');
        });
    }

    // 載入題目資料
    function loadQuestions() {
      const questionsRef = ref(taskDatabase, '/questions');
      onValue(questionsRef, (snapshot) => {
        const data = snapshot.val();
        allQuestions = [];

        if (data) {
          Object.keys(data).forEach(key => {
            allQuestions.push({ id: key, ...data[key] });
          });
        }
        filteredQuestions = allQuestions;
        updateQuestionList();
      });
    }

    loadQuestions();
  </script>

</body>
</html>
