<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ´¾é¡Œä¸­å¿ƒ - ç™½è²“å·¥ä½œå®¤</title>
  <link rel="stylesheet" href="../task-system/task-style.css">
</head>
<body>

  <header>
    <div class="wizard-section">
      <p>ğŸª„ é€™è£¡æœ‰å‡ºé¡Œå°ç²¾éˆå¯ä»¥å¹«ä½ å¿«é€Ÿæ–°å¢é¡Œç›®å–”ï¼</p>
      <button onclick="window.location.href='task-editor.html'">ğŸª„ é–‹å•Ÿå‡ºé¡Œå°ç²¾éˆ</button>
    </div>

    <h1>æ´¾é¡Œä¸­å¿ƒ - ç™½è²“å·¥ä½œå®¤</h1>

    <div class="filter-section">
      <h3>ğŸ” é¡Œç›®ç¯©é¸å™¨</h3>

      <label>å‡ºé¡Œæ—¥æœŸï¼š</label>
      <input type="date" id="filterDate">

      <label>å­¸ç¨‹ï¼š</label>
      <select id="filterCourseLevel">
        <option value="">å…¨éƒ¨</option>
        <option value="åœ‹å°ä¸­å¹´ç´š">åœ‹å°ä¸­å¹´ç´š</option>
        <option value="åœ‹å°é«˜å¹´ç´š">åœ‹å°é«˜å¹´ç´š</option>
        <option value="åœ‹ä¸­">åœ‹ä¸­</option>
        <option value="é«˜ä¸­">é«˜ä¸­</option>
      </select>

      <label>ç§‘ç›®ï¼š</label>
      <select id="filterSubject">
        <option value="">å…¨éƒ¨</option>
        <option value="åœ‹èª">åœ‹èª</option>
        <option value="æ•¸å­¸">æ•¸å­¸</option>
        <option value="è‡ªç„¶">è‡ªç„¶</option>
        <option value="ç¤¾æœƒ">ç¤¾æœƒ</option>
        <option value="è‹±æ–‡">è‹±æ–‡</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>

      <button id="filterBtn">ğŸ” ç¯©é¸é¡Œç›®</button>
    </div>
  </header>

  <main>
    <section class="question-bank">
      <h2>é¡Œç›®æ¸…å–®</h2>
      <div id="questionList">
        <!-- é¡Œç›®åˆ—è¡¨ -->
      </div>
    </section>
  </main>

  <script type="module">
    import { taskDatabase } from "./firebase-config-task.js";
    import { ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
    import { uploadCurrentQuestion } from "./task-database.js";

    const questionListDiv = document.getElementById('questionList');
    const filterDateInput = document.getElementById('filterDate');
    const filterCourseLevelSelect = document.getElementById('filterCourseLevel');
    const filterSubjectSelect = document.getElementById('filterSubject');
    const filterBtn = document.getElementById('filterBtn');

    let allQuestions = [];
    let filteredQuestions = [];

    filterBtn.addEventListener('click', updateFilter);

    function updateFilter() {
      const filterDate = filterDateInput.value;
      const filterCourseLevel = filterCourseLevelSelect.value;
      const filterSubject = filterSubjectSelect.value;

      filteredQuestions = allQuestions.filter(q => {
        const matchDate = filterDate ? q.date === filterDate : true;
        const matchCourse = filterCourseLevel ? q.courseLevel === filterCourseLevel : true;
        const matchSubject = filterSubject ? q.subject === filterSubject : true;
        return matchDate && matchCourse && matchSubject;
      });

      updateQuestionList();
    }

    function updateQuestionList() {
      questionListDiv.innerHTML = '';

      if (filteredQuestions.length === 0) {
        questionListDiv.innerHTML = '<p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¡Œç›®ï¼Œè«‹èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚</p>';
        return;
      }

      filteredQuestions.forEach((q, index) => {
        const qDiv = document.createElement('div');
        qDiv.className = 'question-item';
        qDiv.innerHTML = `
          <strong>é¡Œ${index + 1}:</strong> ${q.text}<br>
          <button onclick="assignQuestion(${index})">ğŸ“¤ æ´¾é€é€™é¡Œ</button> 
          <button onclick="assignHandwriteQuestion(${index})">âœï¸ æ‰‹å¯«æ´¾é¡Œ</button>
          <hr>
        `;
        questionListDiv.appendChild(qDiv);
      });
    }

    // æ´¾é€åˆ° /currentQuestionï¼ˆä¸€èˆ¬å‡ºé¡Œï¼‰
    window.assignQuestion = function(index) {
      const question = filteredQuestions[index];
      if (!question) {
        alert('é¡Œç›®ä¸å­˜åœ¨ï¼');
        return;
      }
      uploadCurrentQuestion(question);
      alert(`âœ… å·²å°‡é¡Œ${index + 1}æ´¾é€çµ¦ç­ç´šï¼`);
    }

    // æ´¾é€åˆ° /teacher/questionï¼ˆæ‰‹å¯«ä½œç­”ï¼‰
    window.assignHandwriteQuestion = function(index) {
      const question = filteredQuestions[index];
      if (!question) {
        alert('é¡Œç›®ä¸å­˜åœ¨ï¼');
        return;
      }

      const now = Date.now();
      const handwriteData = {
        id: question.id || `Q-${now}`,
        timestamp: now,
        content: question.text
      };

      const teacherQuestionRef = ref(taskDatabase, '/teacher/question');
      set(teacherQuestionRef, handwriteData)
        .then(() => {
          alert(`âœ… å·²æ´¾é€åˆ°æ‰‹å¯«ä½œç­”ç³»çµ±ï¼`);
        })
        .catch((error) => {
          console.error('âŒ æ´¾é€å¤±æ•—ï¼š', error);
          alert('æ´¾é€å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ä¸»æ§å°(console)');
        });
    }

    // è¼‰å…¥é¡Œç›®è³‡æ–™
    function loadQuestions() {
      const questionsRef = ref(taskDatabase, '/questions');
      onValue(questionsRef, (snapshot) => {
        const data = snapshot.val();
        allQuestions = [];

        if (data) {
          Object.keys(data).forEach(key => {
            allQuestions.push({ id: key, ...data[key] });
          });
        }
        filteredQuestions = allQuestions;
        updateQuestionList();
      });
    }

    loadQuestions();
  </script>

</body>
</html>
