<!-- StudentUi_Login.html 版本:1.1.0 修正時間:2025-05-01 12:05 -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>學生介面 (Student UI)</title>
  <link rel="stylesheet" href="Student-Interface.css" />
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, off } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

    // Firebase 設定
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    // 初始化
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM Elements
    const el = {
      studentName: document.getElementById('student-name'),
      studentClass: document.getElementById('student-class'),
      chatList: document.getElementById('chatList'),
      sysMsg: document.getElementById('systemMessage'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.querySelector('.send-btn')
    };

    // 讀取 sessionStorage 資料
    const sid = sessionStorage.getItem('studentId') || '';
    const sname = sessionStorage.getItem('studentName') || '匿名';
    const sclass = sessionStorage.getItem('studentClass') || '';
    el.studentName.textContent = sname;
    el.studentClass.textContent = sclass;

    // 切換聊天室監聽函式
    let currentChatListenerRef = null;
    function switchChatListener(qid, title) {
      if (currentChatListenerRef) {
        off(currentChatListenerRef);
      }
      currentChatListenerRef = ref(db, `chat/${qid}`);
      onValue(currentChatListenerRef, snapshot => {
        const data = snapshot.val() || {};
        el.chatList.innerHTML = '';
        Object.values(data).forEach(msg => {
          const li = document.createElement('li');
          li.textContent = `${msg.from||msg.studentId}: ${msg.text||msg.message}`;
          el.chatList.appendChild(li);
        });
      }, err => console.error('聊天室監聽錯誤:', err));
      el.sysMsg.textContent = `聊天室：${title}`;
    }

    // 送出聊天室訊息
    function sendChatMessage() {
      const text = el.chatInput.value.trim();
      if (!text) return;
      push(ref(db, 'chat/lobby'), {
        studentId: sid,
        from: sname,
        text: text,
        timestamp: Date.now()
      });
      el.chatInput.value = '';
    }
    el.sendBtn.addEventListener('click', sendChatMessage);

    // 初始化監聽
    document.addEventListener('DOMContentLoaded', () => {
      switchChatListener('lobby', '大廳');
    });
  </script>
</head>
<body>
  <header>
    <h2>歡迎，<span id="student-name"></span> (<span id="student-class"></span>)</h2>
  </header>
  <section class="chat-container">
    <div id="systemMessage" class="system-message"></div>
    <ul id="chatList" class="chat-list"></ul>
    <textarea id="chatInput" class="chat-input" placeholder="輸入訊息..."></textarea>
    <button class="send-btn">送出聊天室訊息</button>
  </section>
</body>
</html>
