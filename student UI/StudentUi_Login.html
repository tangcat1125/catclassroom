<!-- ✅ 已修正聊天室功能 StudentUi_Login.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>學生作答區</title>
    <link rel="stylesheet" href="Student-Interface.css" />
    <style>
      .highlight-blink {
        background-color: #ffecb3;
        animation: blink 1s step-start 3;
      }
      @keyframes blink {
        50% { background-color: #ffe066; }
        100% { background-color: #ffecb3; }
      }
      .chat-area {
        max-height: 180px;
        overflow-y: auto;
        padding: 10px;
        background-color: #fff0f5;
        border: 2px solid #f8bbd0;
        border-radius: 12px;
        margin-bottom: 12px;
        font-size: 15px;
      }
      .chat-input-box {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .chat-input-box textarea {
        width: 100%;
        padding: 10px;
        font-size: 15px;
        border-radius: 8px;
        border: 1px solid #ccc;
        resize: vertical;
      }
    </style>
  </head>

  <body>
    <div class="student-ui">
      <div class="header">
        <h2>學生作答區</h2>
        <div class="student-info">
          班級：<span id="student-class">...</span>
          姓名：<span id="student-name">...</span>
          <div id="red-light" class="light red"></div>
        </div>
      </div>

      <div class="message-board">
        <h3>📢 系統訊息</h3>
        <div id="systemMessage">等待老師出題中...</div>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
        </div>
        <div id="messageList"></div>
      </div>

      <div class="answer-panel" id="answerPanel" style="display: none;">
        <h3>請作答：</h3>
        <div id="questionText"></div>
        <div id="answerButtons"></div>
      </div>

      <div class="help-box">
        <button id="help-button" class="send-btn">🆘 我要求救</button>
        <div id="helpForm" style="display: none; margin-top: 10px;">
          <textarea id="helpText" placeholder="請輸入你遇到的問題..." rows="4" style="width: 100%; padding: 10px;"></textarea>
          <button onclick="sendHelp()" class="send-btn" style="margin-top: 10px;">🚀 發送給老師</button>
          <div id="helpStatus" class="flash-text" style="display: none;">✅ 已傳送求救訊息</div>
        </div>
      </div>

      <div class="chat-box">
        <h3 style="color: #f48fb1;">課程聊天室</h3>
        <div id="chatList" class="chat-area"></div>
        <div class="chat-input-box">
          <textarea id="chatInput" placeholder="輸入聊天室訊息..." rows="2"></textarea>
          <button onclick="sendChatMessage()" class="send-btn">送出聊天室訊息</button>
        </div>
      </div>

      <div class="help-box" style="margin-top: 30px;">
        <h3>💬 留言牆（大家都看得到喔）</h3>
        <textarea id="publicMessage" placeholder="輸入你想說的話..." rows="3" style="width: 100%; padding: 10px;"></textarea>
        <button onclick="sendPublicMessage()" class="send-btn" style="margin-top: 10px;">送出留言</button>
      </div>
    </div>

    <img src="cat.png" alt="白貓" style="position: fixed; bottom: 8px; right: 8px; width: 60px; opacity: 0.9;" />

    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBB3wmBveYumzmPUQuIr4ApZYxKnnT-IdA",
        authDomain: "catclassroom-login.firebaseapp.com",
        databaseURL: "https://catclassroom-login-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "catclassroom-login",
        storageBucket: "catclassroom-login.appspot.com",
        messagingSenderId: "123487233181",
        appId: "1:123487233181:web:aecc2891dc2d1096962074"
      };
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.database();
    </script>

    <script type="module" src="student-ui.js"></script>

    <script>
      function listenToPublicWall() {
        const wallDiv = document.getElementById("messageList");
        const wallRef = window.db.ref("publicWall");

        wallRef.on("value", (snapshot) => {
          const data = snapshot.val();
          wallDiv.innerHTML = "";
          if (!data) return;

          const today = new Date().toISOString().slice(0, 10);
          const msgs = Object.values(data).filter(msg => msg.time && msg.time.startsWith(today));

          msgs.forEach((msg) => {
            const div = document.createElement("div");
            const isMention = msg.text.includes("@");
            div.innerHTML = `🗯️ <strong>${msg.from}</strong>：<span${isMention ? " class='highlight-blink'" : ""}>${msg.text}</span>`;
            wallDiv.appendChild(div);
          });
        });
      }

      function sendPublicMessage() {
        const name = document.getElementById("student-name").innerText || "匿名";
        const text = document.getElementById("publicMessage").value.trim();
        if (!text) return;

        const newMsg = {
          from: name,
          text: text,
          time: new Date().toISOString()
        };

        window.db.ref("publicWall").push(newMsg);
        document.getElementById("publicMessage").value = "";
      }

      window.addEventListener("DOMContentLoaded", () => {
        listenToPublicWall();
      });
    </script>
  </body>
</html>
