<!-- START OF FILE rollcall.html (兩欄式版本) -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>學生登入 - 白貓教室</title>
  <!-- ** 確保引入了正確的 CSS ** -->
  <link rel="stylesheet" href="rollcall-style.css" />
  <!-- 內嵌一些基本樣式以防 CSS 載入失敗 -->
  <style>
     body { font-family: "Microsoft JhengHei", sans-serif; background-color: #e3f2fd; margin: 0; padding: 20px; }
     .container { max-width: 420px; margin: 50px auto; background-color: #fff; border-radius: 12px; padding: 30px 25px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
     h2 { text-align: center; color: #0d47a1; margin-bottom: 25px; }
     label { display: block; font-size: 16px; margin-top: 15px; margin-bottom: 5px; color: #333; }
     input, select { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
     button { width: 100%; margin-top: 25px; padding: 14px; font-size: 18px; background-color: #42a5f5; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
     button:hover { background-color: #1976d2; }
     .note { text-align: center; margin-top: 15px; font-size: 15px; color: green; min-height: 1.2em; }
     .corner-cat { position: fixed; bottom: 8px; right: 8px; width: 60px; opacity: 0.9; }
  </style>
</head>
<body>
  <div class="container">
    <h2>學生登入</h2>
    <label for="mode">我是...</label>
    <select id="mode" onchange="toggleMode()">
      <option value="self" selected>本班學生</option>
      <option value="guest">其他班來賓</option>
    </select>

    <label for="name">請輸入您的暱稱或本名：</label>
    <input type="text" id="name" placeholder="如：小熊 / Lily / Quentin" required />

    <div id="seat-box">
      <label for="seat">請輸入您的座號（數字）：</label>
      <input type="number" id="seat" min="1" max="99" required /> <!-- 最大座號可調整 -->
    </div>

    <button type="button" onclick="submitLogin()">登入教室</button> <!-- 改成 type="button" 避免預設提交 -->
    <div id="result" class="note"></div>
  </div>

  <img src="cat.png" alt="cat" class="corner-cat" onerror="this.style.display='none';" />

  <!-- Firebase 初始化 (獨立於 student-ui.js) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js"></script>
  <script>
    // ** 請再次確認這裡的 Firebase 配置是否正確 **
    const firebaseConfig = {
      apiKey: "AIzaSyBB3wmBveYumzmPUQuIr4ApZYxKnnT-IdA",
      authDomain: "catclassroom-login.firebaseapp.com",
      databaseURL: "https://catclassroom-login-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "catclassroom-login",
      storageBucket: "catclassroom-login.appspot.com",
      messagingSenderId: "123487233181",
      appId: "1:123487233181:web:aecc2891dc2d1096962074" // 這個 ID 是否和 student-ui 用的一樣?
    };
    let db;
    try {
         const app = initializeApp(firebaseConfig);
         db = getDatabase(app);
         console.log("Rollcall Firebase Initialized");
    } catch (e) {
         console.error("Rollcall Firebase Init Failed:", e);
         alert("登入服務初始化失敗，請稍後再試！");
         // 禁用按鈕
         const loginButton = document.querySelector('button');
         if(loginButton) loginButton.disabled = true;
    }


    window.toggleMode = function () {
      const mode = document.getElementById("mode").value;
      const seatBox = document.getElementById("seat-box");
      const seatInput = document.getElementById("seat"); // 保存對舊 input 的引用
      if (mode === "self") {
        seatBox.innerHTML = `
          <label for="seat">請輸入您的座號（數字）：</label>
          <input type="number" id="seat" min="1" max="99" required />
        `;
        // 可能需要恢復舊 input 的值 (如果之前切換過)
        // if (seatInput && seatInput.type === 'number') {
        //    document.getElementById('seat').value = seatInput.value;
        // }
      } else {
        seatBox.innerHTML = `
          <label for="seat">請選擇您的外班代號：</label>
          <select id="seat" required>
            <option value="">請選擇...</option>
            ${Array.from({ length: 30 }, (_, i) => `<option value="G${i + 1}">G${i + 1}</option>`).join("")}
          </select>
        `;
         // 可能需要恢復舊 select 的值
        // if (seatInput && seatInput.tagName === 'SELECT') {
        //    document.getElementById('seat').value = seatInput.value;
        // }
      }
    }

    window.submitLogin = async function () {
      if (!db) { // 檢查 DB 是否成功初始化
           alert("登入服務尚未準備好，請稍候！");
           return;
      }
      const nameInput = document.getElementById("name");
      const seatSelectOrInput = document.getElementById("seat");
      const mode = document.getElementById("mode").value;

      const name = nameInput.value.trim();
      const seatValue = seatSelectOrInput.value;

      if (!name || !seatValue) {
        alert("請完整填寫暱稱與座號/代號！");
        // 讓沒填的欄位變紅提示 (可選)
        if(!name) nameInput.style.borderColor = 'red'; else nameInput.style.borderColor = '#ccc';
        if(!seatValue) seatSelectOrInput.style.borderColor = 'red'; else seatSelectOrInput.style.borderColor = '#ccc';
        return;
      }
       // 恢復邊框顏色
       nameInput.style.borderColor = '#ccc';
       seatSelectOrInput.style.borderColor = '#ccc';


      // ** 根據模式決定 studentId 和 studentClass **
      let studentId;
      let studentClassText; // 用於顯示，不再存入 sessionStorage
      if (mode === "self") {
          studentId = seatValue.toString().padStart(2, "0"); // 確保座號補零
          studentClassText = `本班 ${studentId}號`; // 用於顯示
      } else {
          studentId = seatValue; // 外班直接用 G1, G2...
          studentClassText = `外班訪客 (${studentId})`;
      }

      console.log(`準備登入: ID=${studentId}, Name=${name}, ClassText=${studentClassText}`);


      const loginData = {
        StudentName: name,
        StudentID: studentId, // 使用我們定義的 ID 格式
        Timestamp: new Date().toISOString()
      };

      const resultDiv = document.getElementById("result");
      const loginButton = document.querySelector('button');
      loginButton.disabled = true; // 防止重複提交
      resultDiv.innerText = "登入中...";

      try {
        // 寫入 Firebase /login/{studentId}
        await set(ref(db, `login/${studentId}`), loginData);
        console.log("Firebase 寫入成功！");
        resultDiv.innerText = `✅ 您已登入為 ${name} (${studentClassText})，將跳轉...`;

        // ** 存入 sessionStorage (只存 ID 和 Name) **
        sessionStorage.setItem("studentId", studentId);
        sessionStorage.setItem("studentName", name);
        // ** 不再存 studentClass，改存 studentSeatId **
        sessionStorage.setItem("studentSeatId", studentId); // 座號 ID 也用 studentId

        // 延遲跳轉
        setTimeout(() => {
             window.location.href = "StudentUi_Login.html";
        }, 1200); // 稍微加長延遲

      } catch (error) {
        console.error("❌ Firebase 寫入失敗：", error);
        resultDiv.innerText = `❌ 登入失敗: ${error.message}`;
        alert("登入失敗，請檢查網路或稍後再試！");
        loginButton.disabled = false; // 恢復按鈕
      }
    }
  </script>
</body>
</html>
<!-- END OF FILE rollcall.html (兩欄式版本) -->
