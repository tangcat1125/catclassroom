import { getDatabase, ref, onValue, set, push } from "firebase/database";

// Firebase 初始化
const db = getDatabase();

// 學生資訊（這應該是登入頁傳來或儲存的）
const studentName = sessionStorage.getItem("studentName");
const studentId = sessionStorage.getItem("studentId");
const studentClass = sessionStorage.getItem("studentClass");

// 🎓 顯示學生資料
document.getElementById("student-name").innerText = studentName;
document.getElementById("student-class").innerText = studentClass;

// 🟧 橘燈點擊開啟留言框
document.getElementById("help-button").addEventListener("click", () => {
  const helpMsg = prompt("請輸入想傳給老師的訊息：");
  if (helpMsg) {
    set(ref(db, `help/${studentId}`), {
      message: helpMsg,
      time: new Date().toISOString()
    });
  }
});

// 🔴 監聽老師是否出題
const questionRef = ref(db, "teacher/question");

onValue(questionRef, (snapshot) => {
  const data = snapshot.val();
  const redLight = document.getElementById("red-light");
  if (data && data.active) {
    redLight.classList.add("active");

    // 出現中型跳窗
    const modal = document.getElementById("question-modal");
    document.getElementById("question-image").src = data.image || "";
    modal.style.display = "flex";
  } else {
    redLight.classList.remove("active");
    document.getElementById("question-modal").style.display = "none";
  }
});

// 🟩 截圖標記完成 → 通知老師（假設用 canvas 或拍照）
document.getElementById("submit-answer").addEventListener("click", () => {
  set(ref(db, `answers/${studentId}`), {
    name: studentName,
    time: new Date().toISOString(),
    status: "done"
  });

  // 亮綠燈顯示送出成功
  alert("✅ 已送出給老師！");
  document.getElementById("question-modal").style.display = "none";
});
