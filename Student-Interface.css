import { getDatabase, ref, onValue, set, push } from "firebase/database";

// Firebase åˆå§‹åŒ–
const db = getDatabase();

// å­¸ç”Ÿè³‡è¨Šï¼ˆé€™æ‡‰è©²æ˜¯ç™»å…¥é å‚³ä¾†æˆ–å„²å­˜çš„ï¼‰
const studentName = sessionStorage.getItem("studentName");
const studentId = sessionStorage.getItem("studentId");
const studentClass = sessionStorage.getItem("studentClass");

// ğŸ“ é¡¯ç¤ºå­¸ç”Ÿè³‡æ–™
document.getElementById("student-name").innerText = studentName;
document.getElementById("student-class").innerText = studentClass;

// ğŸŸ§ æ©˜ç‡ˆé»æ“Šé–‹å•Ÿç•™è¨€æ¡†
document.getElementById("help-button").addEventListener("click", () => {
  const helpMsg = prompt("è«‹è¼¸å…¥æƒ³å‚³çµ¦è€å¸«çš„è¨Šæ¯ï¼š");
  if (helpMsg) {
    set(ref(db, `help/${studentId}`), {
      message: helpMsg,
      time: new Date().toISOString()
    });
  }
});

// ğŸ”´ ç›£è½è€å¸«æ˜¯å¦å‡ºé¡Œ
const questionRef = ref(db, "teacher/question");

onValue(questionRef, (snapshot) => {
  const data = snapshot.val();
  const redLight = document.getElementById("red-light");
  if (data && data.active) {
    redLight.classList.add("active");

    // å‡ºç¾ä¸­å‹è·³çª—
    const modal = document.getElementById("question-modal");
    document.getElementById("question-image").src = data.image || "";
    modal.style.display = "flex";
  } else {
    redLight.classList.remove("active");
    document.getElementById("question-modal").style.display = "none";
  }
});

// ğŸŸ© æˆªåœ–æ¨™è¨˜å®Œæˆ â†’ é€šçŸ¥è€å¸«ï¼ˆå‡è¨­ç”¨ canvas æˆ–æ‹ç…§ï¼‰
document.getElementById("submit-answer").addEventListener("click", () => {
  set(ref(db, `answers/${studentId}`), {
    name: studentName,
    time: new Date().toISOString(),
    status: "done"
  });

  // äº®ç¶ ç‡ˆé¡¯ç¤ºé€å‡ºæˆåŠŸ
  alert("âœ… å·²é€å‡ºçµ¦è€å¸«ï¼");
  document.getElementById("question-modal").style.display = "none";
});
